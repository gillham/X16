# Network Kompile

This tool allows you to send source files from a retro computer to a modern computer to be compiled or assembled and download the resulting binary.  If the toolchain (compiler or assembler) generates an error it is sent to the retro computer and no binary is transferred.

This can be used to compile Prog8 programs edited on the Commander X16 by sending to your modern machine. 


# Requirements
You'll need:
 - Commander X16 or OtterX hardware. (until the emulator supports networking)
 - The most excellent Calypso board installed.
 - Latest Calypso ESP32 firmware, possibly compiled from the git repository.
 - The custom X16 rom and driver for the Calypso installed and configured.
 - `NET.BIN` driver which the Calypso should serve up automatically.
 - The server `nkd.py` currently requires macOS or Linux.  Windows will be supported soon.

You can verify your Calypso is serving up the driver by running:
```
LOAD"//:NET.BIN"
```

This file should load via the Calypso and is not required to be on the SD card.
Note that you can only load it from the root directory hence the `//:` before the filename.


# Usage

On the retro computer you can put `nk` in the root directory or a sub-directory.
The `nk` tool depends on a configuration file describing your build environment.

A good setup is to have a sub-directory with your source code and the `file.nk` configuration for each of your projects.  The `nk` tool can be anywhere, you just need to run it while in the same directory as your `file.nk` and source code.

Once you have everything setup to build your project you just run `nk`.
```
^//:nk
```
The above assumes `nk` is in the root of the SD.  You could put in a `/bin` directory
and run it like this:
```
^//bin/:nk
```

You can be in any directory when you run `nk` as it just looks in the *current* directory
for `file.nk` and source files.


# Layout of file.nk

Below is an example `file.nk` for a Hello World type of project.
```
>HOST:192.168.1.10:8056
>PROJECT:hello.prg
>TARGET:cx16prog8
>FILES:2
>MAIN:hello.p8
>EXTRA:module.p8
```

Running `nk` with `file.nk` and `hello.p8` in the current directory will send `hello.p8` to be compiled and should result in `hello.prg` in the current directory.

Lets go over each line of the config file.

`>HOST:192.168.1.10:8056`

This defines the host and port for your modern computer running `nkd.py` the server program.
This shows an ip address, but a fully qualified domain name (FQDN) like `mycomputer.domain.com` can also be used.  Just a hostname like `mycomputer` will cause a crash, don't do it.

`>PROJECT:hello.prg`

This line identifies your project but really it should specify the filename that will be
generated by the compiler or assembler that you expect to be sent back.  For Prog8 this
should match the source file since a file called `main.p8` will be compiled as `main.prg` automatically.  So in this example the main source file must be `hello.p8` for this to work.

`>TARGET:cx16prog8`

This tells the server what toolchain to use.  A list of supported toolchains are in the `targets.json` file with the server components and at the end of this document.
In this example the target is the Commander X16 target (cx16) of prog8c.

`>FILES:2`

This line just specifies how many files we will be sending to the modern computer.
It is possible to send several files and this parameter helps validate we have sent the correct number of files.

`>MAIN:hello.p8`

This is your main source file and for Prog8 especially this needs to match your project parameter above or you won't get your binary sent back.  This is the file that is passed to the toolchain and it is expected to include other files as needed.
(In the future this process will be refined in the future to support toolchains where multiple files are provided and an output file is specified as well.)


`>EXTRA:module.p8`

This is the only parameter that can be specified more than once.  Its primary purpose is to
send any additional modules needed by the toolchain.  For Prog8 this would be any extra
modules you create that are imported via the `%import` option or via `%asmbinary` or `%asminclude` keywords.
With something like cc65 this could be additional C language files or headers with a `.h` extension.


# Running the nkd server

Check the nkd directory in this repository for more information.
Essentially the server is a Python script that listens for incoming TCP connections.
You'll need the toolchains you want to support in your path.  Aliases may not work
with Python.


## Future

The tool needs additional error checking to improve stability as well as the ability to send some toolchain arguments and potentially the ability to receive multiple files back from the server.

Additional networking devices besides the Calypso should be supported.  For the official "Serial & ESP32 Network" card a driver will need to be written to expose the ZiModem socket API, hopefully in a manner compatible with the Calypso API. It may be necessary to replace the ESP32 firmware (running ZiModem) with something more like Calypso or add a special mode.

Additional systems supported by Prog8 should get supported as well.  C64 will get support first as it has several networking options that may be usable.  This includes UserPort ESP32 modems running ZiModem as well as devices like the WiC64 that function more like a NIC than a modem.

